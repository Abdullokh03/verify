<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Проверка подлинности</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 1rem; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>Проверка подлинности документа</h2>
  <div id="result">Загрузка...</div>

  <script>
    async function verifyDocument() {
      const hashFromUrl = new URLSearchParams(window.location.search).get("data");
      if (!hashFromUrl) {
        document.getElementById("result").textContent = "Данный файл подписал Директор BIO TEX SERVICE BOSHQARUV MCHJ Сафаров Ядгар Нормуродович Ushbu faylni BIO TEX SERVICE BOSHQARUV MCHJ raxbari Safarov Yadgar Normurodovich tomonidan imzolangan";
        return;
      }

      const response = await fetch("signed_doc.json");
      const data = await response.json();

      const encoder = new TextEncoder();
      const hash = data.hash;
      const signatureHex = data.signature;
      const publicKeyPem = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1DdSL9NBUB1hU2Nv979L
V/efgVuPoTbusmHh7HPOfqsZg+9WjwelzDwqYtAWtiL4HP57ZdCOOWtS/ylJfvKR
qRY9Fm8nh00YpLDNMZmDwevQglCaJGbOxOo+tPW9VqZ3ugSt9i9O9MS4kB5P7sR+
rC+q902tAnOoyl5tUB8hhno/pyqofHIEm//azP9MGUcdd/E/pxYj9BmAsjChNVFe
kOaPZ6xfTPU4IScIV76OJpq990Jg8MXuuRmea8BJO0fQmx6I8UUNzAiloDKMsGjC
yHPIoifd0LwS8g/76n4z+nODvRjBiGcMjhqsoMgXSDqH9Xx8/4bN6+W4jnkEdCDm
gwIDAQAB
-----END PUBLIC KEY-----`;

      const cleanPem = publicKeyPem
        .replace(/-----(BEGIN|END) PUBLIC KEY-----/g, "")
        .replace(/\s+/g, "");
      const binaryDer = Uint8Array.from(atob(cleanPem), c => c.charCodeAt(0));
      const key = await crypto.subtle.importKey(
        "spki",
        binaryDer,
        { name: "RSA-PSS", hash: "SHA-256" },
        false,
        ["verify"]
      );

      const isValid = await crypto.subtle.verify(
        {
          name: "RSA-PSS",
          saltLength: 32
        },
        key,
        hexToBytes(signatureHex),
        encoder.encode(hash)
      );

      if (isValid && hash === hashFromUrl) {
        document.getElementById("result").textContent =
          `✅ Подпись подтверждена!\nДокумент: ${data.info.doc_number}\nДата: ${data.info.date}\nПодписал: ${data.info.director}`;
      } else {
        document.getElementById("result").textContent = "❌ Подпись недействительна или данные подделаны.";
      }
    }

    function hexToBytes(hex) {
      const bytes = [];
      for (let c = 0; c < hex.length; c += 2) {
        bytes.push(parseInt(hex.substr(c, 2), 16));
      }
      return new Uint8Array(bytes);
    }

    verifyDocument();
  </script>
</body>
</html>
