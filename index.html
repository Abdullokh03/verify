<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Проверка подлинности</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    #result { white-space: pre-wrap; background: #f2f2f2; padding: 1rem; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>Проверка подлинности документа</h2>
  <div id="result">Загрузка...</div>

  <script>
    async function verifyDocument() {
      const hashFromUrl = new URLSearchParams(window.location.search).get("data");
      if (!hashFromUrl) {
        document.getElementById("result").textContent = "Данный файл подписал Директор BIO TEX SERVICE BOSHQARUV M.CH.J. Сафаров Ядгар Нормуродович
          Ushbu faylni BIO TEX SERVICE BOSHQARUV M.CH.J. raxbari Safarov Yadgar Normurodovich tomonidan imzolangan";
        return;
      }

      const response = await fetch("signed_doc.json");
      const data = await response.json();

      const encoder = new TextEncoder();
      const hash = data.hash;
      const signatureHex = data.signature;
      const publicKeyPem = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA111NexSaNYphUOxJULHG
+8MLHME/A/YWcEjX3ntykmYDGSNgKrAoJPUpURzxj5KwlqNpSLmadqKUEH9Wyxqi
7YNg0nC5SfsKgBFJQpYz+s3y6LgTxiaKlJuaGmVkWRIVl+zXqsW2J+HrEquGOA7k
jE4pDqBpd4NThcTZdEq85KeyWDpY/6YvCHmQhp+gxIuMxCZWPNE8eFQ/bD9QEb9R
KUeukDc3bdxy7EZBZ6zkw+khrC9+kYS9kkx3QhyHHQbLLe13b3cJJjgcAgaISOsV
3cNHatTdnZYtb8nHdKab/kw1VpXSp0ce91gENVrdFcE3cMa/pkNNUFaa7fZm5ZPe
wQIDAQAB
-----END PUBLIC KEY-----`;

      const cleanPem = publicKeyPem
        .replace(/-----(BEGIN|END) PUBLIC KEY-----/g, "")
        .replace(/\s+/g, "");
      const binaryDer = Uint8Array.from(atob(cleanPem), c => c.charCodeAt(0));
      const key = await crypto.subtle.importKey(
        "spki",
        binaryDer,
        { name: "RSA-PSS", hash: "SHA-256" },
        false,
        ["verify"]
      );

      const isValid = await crypto.subtle.verify(
        {
          name: "RSA-PSS",
          saltLength: 32
        },
        key,
        hexToBytes(signatureHex),
        encoder.encode(hash)
      );

      if (isValid && hash === hashFromUrl) {
        document.getElementById("result").textContent =
          `✅ Подпись подтверждена!\nДокумент: ${data.info.doc_number}\nДата: ${data.info.date}\nПодписал: ${data.info.director}`;
      } else {
        document.getElementById("result").textContent = "❌ Подпись недействительна или данные подделаны.";
      }
    }

    function hexToBytes(hex) {
      const bytes = [];
      for (let c = 0; c < hex.length; c += 2) {
        bytes.push(parseInt(hex.substr(c, 2), 16));
      }
      return new Uint8Array(bytes);
    }

    verifyDocument();
  </script>
</body>
</html>
